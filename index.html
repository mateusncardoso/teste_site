<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>CEP Proximity Map with Minimalistic Style</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Estilo minimalista global */
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Inter', sans-serif;
      background-color: #fafafa;
      color: #333;
    }
    h2 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 20px;
    }
    input, button {
      padding: 8px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
      outline: none;
      margin-right: 5px;
    }
    button {
      background-color: #333;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #555;
    }
    /* Estilização do mapa */
    #map {
      height: 500px;
      max-width: 800px; /* Set the desired width */
      margin: 0 auto;   /* This centers the element horizontally */
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2>Find Points Near Your CEP</h2>
  <div style="text-align:center; margin-bottom:10px;">
    <input type="text" id="cep" placeholder="Enter CEP (e.g., 01001-000)">
    <button id="searchBtn">Search</button>
  </div>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializa o mapa com estilo minimalista (CartoDB Positron)
      // rastertiles/voyager é outra opção de estilo
      var map = L.map('map').setView([-30, -53], 5);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
        attribution: '&copy; OpenStreetMap &copy; CARTO'
      }).addTo(map);

      // Define um ícone personalizado para os demais pontos a partir de uma URL 
      var customIcon = L.icon({
        iconUrl: 'https://www.creativefabrica.com/wp-content/uploads/2023/01/27/Wheat-Bread-Vector-Icon-Graphics-59091810-1.png', // URL do seu marcador
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
      });

      // Define um ícone minimalista para o marcador do CEP (um simples ponto)
      var cepIcon = L.divIcon({
        className: 'cep-marker',
        html: '<div style="width: 10px; height: 10px; background: #000; border-radius: 50%; border: 2px solid #fff;"></div>',
        iconSize: [10, 10],
        iconAnchor: [5, 5]
      });

      // Função para gerar pontos aleatórios com propriedade "city".
      function generateRandomPoints(centerLat, centerLon, count, cityName) {
        var arr = [];
        for (var i = 0; i < count; i++) {
          var latOffset = (Math.random() - 0.5) * 0.06; // Pequeno deslocamento
          var lonOffset = (Math.random() - 0.5) * 0.06;
          arr.push({
            name: cityName + " Point " + (i + 1),
            lat: centerLat + latOffset,
            lon: centerLon + lonOffset,
            city: cityName
          });
        }
        return arr;
      }

      // Gera pontos aleatórios para Porto Alegre e Uruguaiana.
      var portoAlegrePoints = generateRandomPoints(-30.0346, -51.2177, 5, "Porto Alegre");
      var uruguaianaPoints = generateRandomPoints(-29.7601, -57.0886, 5, "Uruguaiana");
      var points = portoAlegrePoints.concat(uruguaianaPoints);

      // Fórmula de Haversine para calcular distância em km entre duas coordenadas.
      function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371;
        var dLat = deg2rad(lat2 - lat1);
        var dLon = deg2rad(lon2 - lon1);
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }
      function deg2rad(deg) {
        return deg * (Math.PI/180);
      }

      // Array para armazenar marcadores (para limpar quando necessário)
      var markers = [];
      function clearMarkers() {
        markers.forEach(function(marker) {
          map.removeLayer(marker);
        });
        markers = [];
      }

      // Ao clicar no botão "Search"
      document.getElementById('searchBtn').addEventListener('click', function() {
        var cep = document.getElementById('cep').value.trim();
        if (!cep) {
          alert("Please enter a CEP.");
          return;
        }
        
        // Endpoint para geocodificar o CEP (substitua pelo seu endpoint se necessário)
        var url = 'https://api-mapa-pao-az2jx74p6a-uc.a.run.app/cep?cep=' + encodeURIComponent(cep);
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (!data || !data.latitude || !data.longitude) {
              alert("CEP not found.");
              return;
            }
            
            var lat = parseFloat(data.latitude);
            var lon = parseFloat(data.longitude);
            var cityName = data.city || "";
            console.log("City from geocoding:", cityName);
            
            clearMarkers();
            map.setView([lat, lon], 12);
            
            // Adiciona marcador para a localização do CEP usando o ícone minimalista.
            var cepMarker = L.marker([lat, lon], { icon: cepIcon }).addTo(map)
              .bindPopup("CEP: " + cep + "<br>" + data.formatted_address);
            markers.push(cepMarker);
            
            var cityPoints = points.filter(function(point) {
              return point.city.toLowerCase() === cityName.toLowerCase();
            });

            if (cityPoints.length > 0) {
              cityPoints.forEach(function(point) {
                var distance = getDistanceFromLatLonInKm(lat, lon, point.lat, point.lon);
                var marker = L.marker([point.lat, point.lon], { icon: customIcon }).addTo(map)
                  .bindPopup(point.name + "<br>Distance: " + distance.toFixed(2) + " km");
                markers.push(marker);
              });
            } else {
              if (cityPoints.length > 0) {
                cityPoints.forEach(function(point) {
                  var distance = getDistanceFromLatLonInKm(lat, lon, point.lat, point.lon);
                  var marker = L.marker([point.lat, point.lon], { icon: customIcon }).addTo(map)
                    .bindPopup(point.name + "<br>Distance: " + distance.toFixed(2) + " km");
                  markers.push(marker);
                });
              } else {
                // Se nenhum ponto for encontrado, exibe popup informativo.
                L.popup()
                  .setLatLng([lat, lon])
                  .setContent("Desculpe, não há pontos de venda próximos a este CEP. Entre em contato!")
                  .openOn(map);
              }
            }
          })
          .catch(error => {
            console.error("Error during geocoding:", error);
          });
      });
    });
  </script>
    <!-- JavaScript to warm up the service -->
  <script>
    window.addEventListener('load', function() {
      fetch("https://api-mapa-pao-az2jx74p6a-uc.a.run.app/_warmup")
        .then(response => response.json())
        .then(data => console.log("Warmup response:", data))
        .catch(error => console.error("Warmup error:", error));
    });
  </script>
</body>
</html>
